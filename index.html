<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å¤¢å¹»åŸå¸‚ App ğŸ˜ï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --purple: #6c5ce7; --gold: #f1c40f; --green: #55efc4; --bg: #f0f2f5; }
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        
        #city-view {
            width: 100%; height: 220px; 
            background: linear-gradient(to bottom, #a1c4fd 0%, #c2e9fb 100%);
            position: sticky; top: 0; display: flex; align-items: flex-end; justify-content: center;
            border-bottom: 5px solid #7ed6df; overflow-x: auto; z-index: 5;
        }
        .building { font-size: 30px; margin: 0 2px; animation: bounceIn 0.5s; }

        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100;
        }
        .nav-item { text-align: center; font-size: 0.8rem; color: #666; cursor: pointer; }
        .nav-item.active { color: var(--purple); font-weight: bold; }
        .nav-icon { font-size: 24px; display: block; }

        .content-area { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .content-area.active { display: block; }

        .panel { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; color: white; margin-right: 5px; }
        .tag-work { background: #0984e3; }
        .tag-school { background: #e17055; }
        .tag-church { background: #6c5ce7; }
        .tag-life { background: #00b894; }

        .task-card { background: #f9f9f9; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--purple); }
        .deadline-badge { font-size: 0.75rem; font-weight: bold; margin-top: 5px; display: block; }
        
        /* ä¿®æ”¹èˆ‡å®Œå·¥æŒ‰éˆ•ç¸®å°æ’ç‰ˆ */
        .btn-group { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        button { border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-edit { background: #dfe6e9; color: #636e72; padding: 6px 12px; font-size: 0.85rem; }
        .btn-done { background: var(--green); color: #2d3436; padding: 6px 15px; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.95); }

        #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; justify-content: center; align-items: center; }
        .modal-box { background:white; padding:20px; border-radius:20px; width:85%; max-width:400px; }
        .modal-box input, .modal-box select { width:100%; padding:10px; margin:10px 0; border-radius:10px; border:1px solid #ddd; box-sizing: border-box;}

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { from { transform: scale(0); } to { transform: scale(1); } }
    </style>
</head>
<body>

<div id="city-view"></div>

<div id="area-todo" class="content-area active">
    <div class="panel">
        <h3>ğŸ—ï¸ æ–°å¢ä»»å‹™</h3>
        <input type="text" id="tInput" placeholder="ä»»å‹™åç¨±" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; margin-bottom:5px;">
        <select id="catInput" style="width:100%; padding:10px; margin:5px 0; border-radius:10px; border:1px solid #ddd;">
            <option value="æ—¥å¸¸">æ—¥å¸¸ (Life)</option>
            <option value="å­¸æ¥­">å­¸æ¥­ (School)</option>
            <option value="å·¥ä½œ">å·¥ä½œ (Work)</option>
            <option value="æ•™æœƒ">æ•™æœƒ (Church)</option>
        </select>
        <textarea id="dInput" placeholder="è©³ç´°å…§å®¹..." style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; margin-top:5px;"></textarea>
        <input type="datetime-local" id="dateInput" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; margin-top:5px;">
        <button onclick="addTask()" style="background:var(--purple); color:white; width:100%; padding:12px; margin-top:10px;">ç™¼å¸ƒæŒ‡ä»¤</button>
    </div>
    <div id="taskList"></div>
</div>

<div id="area-finished" class="content-area">
    <h3>âœ… æœ€è¿‘å®Œå·¥</h3>
    <div id="finishedList"></div>
</div>

<div id="area-museum" class="content-area">
    <div style="text-align: center;">
        <h2 style="color:var(--gold)">ğŸ›ï¸ æˆå°±åšç‰©é¤¨</h2>
        <p>ç´¯è¨ˆå»ºç¯‰ï¼š<b id="totalBuildings">0</b></p>
    </div>
    <div id="achievementList"></div>
</div>

<div id="editModal">
    <div class="modal-box">
        <h3>âœï¸ ä¿®æ”¹ä»»å‹™</h3>
        <input type="text" id="editTitle" placeholder="ä»»å‹™åç¨±">
        <select id="editCat">
            <option value="æ—¥å¸¸">æ—¥å¸¸</option>
            <option value="å­¸æ¥­">å­¸æ¥­</option>
            <option value="å·¥ä½œ">å·¥ä½œ</option>
            <option value="æ•™æœƒ">æ•™æœƒ</option>
        </select>
        <input type="datetime-local" id="editDate">
        <button onclick="saveEdit()" style="background:var(--purple); color:white; width:100%; padding:10px; margin-top:10px;">å„²å­˜ä¿®æ”¹</button>
        <button onclick="closeEdit()" style="background:#eee; color:#666; width:100%; padding:10px; margin-top:5px;">å–æ¶ˆ</button>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="switchArea('todo', this)"><span class="nav-icon">ğŸ—ï¸</span>å·¥åœ°</div>
    <div class="nav-item" onclick="switchArea('finished', this)"><span class="nav-icon">âœ…</span>å®Œå·¥</div>
    <div class="nav-item" onclick="switchArea('museum', this)"><span class="nav-icon">ğŸ›ï¸</span>æˆå°±</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbKZWbc7sJT2OaSs_GG7xw15l9ljMzzMc",
      authDomain: "mybloomcity.firebaseapp.com",
      projectId: "mybloomcity",
      storageBucket: "mybloomcity.firebasestorage.app",
      messagingSenderId: "612870866616",
      appId: "1:612870866616:web:4110f2ae283078940dd64d",
      measurementId: "G-EEXNXD2T18"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const taskCol = collection(db, "myTasks");
    let currentEditId = null;

    onSnapshot(taskCol, (snap) => {
        const tasks = [];
        snap.forEach(d => tasks.push({ id: d.id, ...d.data() }));
        tasks.sort((a, b) => new Date(a.deadline || 9999999999999) - new Date(b.deadline || 9999999999999));
        updateUI(tasks);
    });

    window.addTask = async () => {
        const title = document.getElementById('tInput').value;
        const category = document.getElementById('catInput').value;
        const desc = document.getElementById('dInput').value;
        const deadline = document.getElementById('dateInput').value;
        if (!title) return alert("è«‹è¼¸å…¥åç¨±");
        await addDoc(taskCol, { title, category, desc, deadline, done: false, timestamp: Date.now() });
        document.getElementById('tInput').value = '';
        document.getElementById('dInput').value = '';
    };

    window.finish = async (id) => {
        await updateDoc(doc(db, "myTasks", id), { done: true, finishTime: new Date().toLocaleString() });
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
    };

    window.openEdit = (id, title, date, cat) => {
        currentEditId = id;
        document.getElementById('editTitle').value = title;
        document.getElementById('editDate').value = date || '';
        document.getElementById('editCat').value = cat || 'æ—¥å¸¸';
        document.getElementById('editModal').style.display = 'flex';
    };
    window.closeEdit = () => document.getElementById('editModal').style.display = 'none';
    window.saveEdit = async () => {
        await updateDoc(doc(db, "myTasks", currentEditId), {
            title: document.getElementById('editTitle').value,
            deadline: document.getElementById('editDate').value,
            category: document.getElementById('editCat').value
        });
        closeEdit();
    };

    window.switchArea = (area, el) => {
        document.querySelectorAll('.content-area').forEach(a => a.classList.remove('active'));
        document.getElementById('area-' + area).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    };

    function updateUI(tasks) {
        const taskList = document.getElementById('taskList');
        const finishedList = document.getElementById('finishedList');
        const achievementList = document.getElementById('achievementList');
        const cityEl = document.getElementById('city-view');
        taskList.innerHTML = ''; finishedList.innerHTML = ''; achievementList.innerHTML = ''; cityEl.innerHTML = '';

        const icons = ["ğŸ ", "ğŸ¡", "ğŸ¢", "ğŸ«", "ğŸ°", "ğŸ¡", "â›²", "ğŸŒ³", "ğŸ¬", "ğŸª"];
        let doneCount = 0;

        tasks.forEach(t => {
            const catClass = `tag-${t.category === 'å·¥ä½œ' ? 'work' : t.category === 'å­¸æ¥­' ? 'school' : t.category === 'æ•™æœƒ' ? 'church' : 'life'}`;
            if (!t.done) {
                taskList.innerHTML += `
                    <div class="task-card">
                        <span class="tag ${catClass}">${t.category || 'æ—¥å¸¸'}</span>
                        <strong>${t.title}</strong>
                        <span class="deadline-badge">${t.deadline ? 'ğŸ“… ' + t.deadline.replace('T',' ') : 'â³ ç„¡æœŸé™'}</span>
                        <div class="btn-group">
                            <button class="btn-edit" onclick="openEdit('${t.id}', '${t.title}', '${t.deadline}', '${t.category}')">âœï¸ ä¿®æ”¹</button>
                            <button class="btn-done" onclick="finish('${t.id}')">å®Œå·¥!</button>
                        </div>
                    </div>`;
            } else {
                const icon = icons[doneCount % icons.length];
                finishedList.innerHTML += `<div class="task-card" style="opacity:0.7"><b>${icon} ${t.title}</b></div>`;
                achievementList.innerHTML += `<div class="panel"><b>${icon} ${t.title}</b><br><small>å®Œå·¥ï¼š${t.finishTime}</small></div>`;
                const span = document.createElement('span');
                span.className = 'building';
                span.innerText = icon;
                cityEl.appendChild(span);
                doneCount++;
            }
        });
        document.getElementById('totalBuildings').innerText = doneCount;
    }
</script>
</body>
</html>