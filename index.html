<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„å¤¢å¹»ä»»å‹™åŸå¸‚ ğŸ˜ï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --main-blue: #a1c4fd; --grass-green: #7ed6df; --purple: #6c5ce7; --gold: #f1c40f; --red: #e74c3c; }
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* åŸå¸‚é¢¨æ™¯å€ */
        #city-view {
            width: 100%; height: 250px; 
            background: linear-gradient(to bottom, #a1c4fd 0%, #c2e9fb 100%);
            position: relative; display: flex; align-items: flex-end; justify-content: center;
            border-bottom: 8px solid var(--grass-green); overflow-x: auto; padding-bottom: 5px;
        }
        .building { font-size: 50px; animation: bounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin: 0 5px; cursor: pointer; }
        
        .container { width: 95%; max-width: 600px; margin-top: -30px; z-index: 10; padding-bottom: 50px; }
        .panel { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        h2, h3 { color: var(--purple); margin-top: 0; }
        input, textarea, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1rem; }
        button { background: var(--purple); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .cal-btn { width: auto; background: #fab1a0; margin-left: 5px; }

        /* ä»»å‹™å¡ç‰‡ */
        .task-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--purple); box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .task-info strong { display: block; font-size: 1.1rem; color: #333; }
        .deadline-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-top: 5px; font-weight: bold; }
        .urgent { background: #ffeaa7; color: #d63031; border: 1px solid #d63031; }
        .normal { background: #f1f2f6; color: #2f3542; }
        
        .actions { display: flex; gap: 8px; margin-top: 10px; }
        .done-btn { background: #55efc4; flex: 1; }

        /* åšç‰©é¤¨æ¨£å¼ */
        #museum { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .museum-content { background: #fdfdfd; width: 90%; max-width: 550px; padding: 25px; border-radius: 30px; max-height: 85vh; overflow-y: auto; text-align: center; }
        .achievement-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        .achieved-item { background: #fff; border: 2px solid #eee; border-radius: 15px; padding: 15px; display: flex; align-items: center; text-align: left; }
        .achieved-icon { font-size: 40px; margin-right: 15px; }

        @keyframes bounceIn { from { transform: scale(0); } to { transform: scale(1); } }
    </style>
</head>
<body>

<div id="city-view" onclick="openMuseum()"></div>

<div class="container">
    <div class="panel">
        <h2>ğŸ—ï¸ åŸå¸‚è¦åŠƒç½²</h2>
        <input type="text" id="tInput" placeholder="ä»»å‹™åç¨±">
        <textarea id="dInput" placeholder="ä»»å‹™è©³æƒ…..."></textarea>
        <input type="datetime-local" id="dateInput">
        <button onclick="addTask()">ç™¼å¸ƒå»ºç¯‰æŒ‡ä»¤</button>
    </div>

    <div class="panel">
        <h3>ğŸ“Œ å»ºç¯‰å·¥åœ° (ä¾æœŸé™æ’åº)</h3>
        <div id="taskList"></div>
    </div>

    <button onclick="openMuseum()" style="background: var(--gold); color: #333;">ğŸ›ï¸ é€²å…¥æˆå°±åšç‰©é¤¨</button>
</div>

<div id="museum" onclick="closeMuseum()">
    <div class="museum-content" onclick="event.stopPropagation()">
        <h2 style="color: var(--gold);">ğŸ›ï¸ æˆå°±åšç‰©é¤¨</h2>
        <p>ç´¯è¨ˆå»ºç¯‰ï¼š<b id="totalBuildings">0</b></p>
        <div id="achievementList" class="achievement-grid"></div>
        <button onclick="closeMuseum()" style="margin-top: 25px; background: #636e72;">è¿”å›åŸå¸‚</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbKZWbc7sJT2OaSs_GG7xw15l9ljMzzMc",
      authDomain: "mybloomcity.firebaseapp.com",
      projectId: "mybloomcity",
      storageBucket: "mybloomcity.firebasestorage.app",
      messagingSenderId: "612870866616",
      appId: "1:612870866616:web:4110f2ae283078940dd64d",
      measurementId: "G-EEXNXD2T18"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const taskCol = collection(db, "myTasks");

    onSnapshot(taskCol, (snap) => {
        const tasks = [];
        snap.forEach(d => tasks.push({ id: d.id, ...d.data() }));
        
        // æ’åºï¼šå…ˆæŒ‰ done ç‹€æ…‹ï¼Œæœªå®Œæˆçš„æŒ‰æˆªæ­¢æ—¥æœŸæ’åº
        tasks.sort((a, b) => {
            if (a.done !== b.done) return a.done ? 1 : -1;
            if (!a.deadline) return 1;
            if (!b.deadline) return -1;
            return new Date(a.deadline) - new Date(b.deadline);
        });
        
        updateUI(tasks);
    });

    window.addTask = async () => {
        const title = document.getElementById('tInput').value;
        const desc = document.getElementById('dInput').value;
        const deadline = document.getElementById('dateInput').value;
        if (!title) return alert("è«‹è¼¸å…¥åç¨±");
        await addDoc(taskCol, { title, desc, deadline, done: false, timestamp: Date.now() });
        document.getElementById('tInput').value = '';
        document.getElementById('dInput').value = '';
        document.getElementById('dateInput').value = '';
    };

    window.finish = async (id) => {
        await updateDoc(doc(db, "myTasks", id), { done: true, finishTime: new Date().toLocaleString() });
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    };

    function getCountdown(deadline) {
        if (!deadline) return { text: "â³ ç„¡æœŸé™", class: "normal" };
        const now = new Date();
        const due = new Date(deadline);
        const diffTime = due - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) return { text: "âŒ å·²é€¾æœŸ", class: "urgent" };
        if (diffDays === 0) return { text: "ğŸ”¥ ä»Šå¤©åˆ°æœŸ", class: "urgent" };
        if (diffDays === 1) return { text: "ğŸ”” æ˜å¤©åˆ°æœŸ", class: "urgent" };
        return { text: `ğŸ“… é‚„æœ‰ ${diffDays} å¤©`, class: "normal" };
    }

    window.addToCal = (title, desc, date) => {
        const d = date ? date.replace(/[-:]/g, "") : "";
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(desc)}&dates=${d}/${d}`;
        window.open(url, '_blank');
    };

    function updateUI(tasks) {
        const taskList = document.getElementById('taskList');
        const achievementList = document.getElementById('achievementList');
        const cityEl = document.getElementById('city-view');
        taskList.innerHTML = ''; achievementList.innerHTML = ''; cityEl.innerHTML = '';

        const icons = ["ğŸ ", "ğŸ¡", "ğŸ¢", "ğŸ¬", "ğŸ«", "ğŸª", "ğŸ°", "ğŸ¡", "â›²", "ğŸŒ³"];
        let doneCount = 0;

        tasks.forEach(t => {
            if (!t.done) {
                const countdown = getCountdown(t.deadline);
                taskList.innerHTML += `
                    <div class="task-card">
                        <div class="task-info">
                            <strong>${t.title}</strong>
                            <span class="deadline-badge ${countdown.class}">${countdown.text}</span>
                            ${t.desc ? `<p>ğŸ“ ${t.desc}</p>` : ''}
                        </div>
                        <div class="actions">
                            <button class="cal-btn" onclick="addToCal('${t.title}', '${t.desc}', '${t.deadline}')">ğŸ“…</button>
                            <button class="done-btn" onclick="finish('${t.id}')">å®Œå·¥!</button>
                        </div>
                    </div>`;
            } else {
                const myIcon = icons[doneCount % icons.length];
                achievementList.innerHTML += `
                    <div class="achieved-item">
                        <div class="achieved-icon">${myIcon}</div>
                        <div class="achieved-text"><strong>${t.title}</strong><small>å®Œå·¥: ${t.finishTime}</small></div>
                    </div>`;
                const span = document.createElement('span');
                span.className = 'building';
                span.innerText = myIcon;
                cityEl.appendChild(span);
                doneCount++;
            }
        });
        document.getElementById('totalBuildings').innerText = doneCount;
    }

    window.openMuseum = () => document.getElementById('museum').style.display = 'flex';
    window.closeMuseum = () => document.getElementById('museum').style.display = 'none';
</script>
</body>
</html>